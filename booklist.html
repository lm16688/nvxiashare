<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ä¹¦å•ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .serif {
            font-family: 'Noto Serif SC', serif;
        }
        .masonry-grid {
            column-count: 1;
            column-gap: 1.5rem;
        }
        @media (min-width: 640px) {
            .masonry-grid { column-count: 2; }
        }
        @media (min-width: 1024px) {
            .masonry-grid { column-count: 3; }
        }
        @media (min-width: 1280px) {
            .masonry-grid { column-count: 4; }
        }
        .break-inside-avoid {
            break-inside: avoid;
            page-break-inside: avoid;
        }
        .book-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .book-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        .modal-enter {
            animation: modalEnter 0.3s ease-out;
        }
        @keyframes modalEnter {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .book-item {
            transition: all 0.2s ease;
        }
        .book-item:hover {
            background-color: rgba(139, 92, 246, 0.05);
        }
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: #c4b5fd;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a78bfa;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- å¤´éƒ¨åŒºåŸŸ -->
    <header class="max-w-7xl mx-auto mb-8 text-center">
        <h1 class="text-4xl md:text-5xl font-bold text-white mb-4 serif tracking-wide">
            ğŸ“š æˆ‘çš„ä¹¦å•
        </h1>
        <p class="text-white/80 text-lg mb-6">è®°å½•é˜…è¯»æ—¶å…‰ï¼Œç®¡ç†æ‚¨çš„ä¹¦ç±æ”¶è—</p>
        
        <!-- ç­›é€‰å™¨å’Œä¸»æ·»åŠ æŒ‰é’® -->
        <div class="glass-effect rounded-2xl p-4 inline-flex flex-wrap gap-4 items-center justify-center shadow-xl">
            <div class="flex items-center gap-2">
                <label class="text-gray-700 font-medium">ç­›é€‰å¹´æœˆï¼š</label>
                <input type="month" id="filterMonth" class="px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition-all">
                <button onclick="clearFilter()" class="px-4 py-2 text-sm text-purple-600 hover:text-purple-800 font-medium transition-colors">
                    æ¸…é™¤ç­›é€‰
                </button>
            </div>
            <div class="h-8 w-px bg-gray-300 hidden md:block"></div>
            <button onclick="createNewList()" class="bg-gradient-to-r from-purple-600 to-blue-600 text-white px-6 py-2 rounded-lg font-medium hover:shadow-lg hover:scale-105 transition-all flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                åˆ›å»ºæ–°ä¹¦å•
            </button>
            <button onclick="exportData()" class="bg-white text-purple-600 border-2 border-purple-600 px-4 py-2 rounded-lg font-medium hover:bg-purple-50 transition-all flex items-center gap-2 text-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                å¯¼å‡ºæ•°æ®
            </button>
            <button onclick="importData()" class="bg-white text-blue-600 border-2 border-blue-600 px-4 py-2 rounded-lg font-medium hover:bg-blue-50 transition-all flex items-center gap-2 text-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                å¯¼å…¥æ•°æ®
            </button>
        </div>
    </header>

    <!-- ä¹¦å•ç€‘å¸ƒæµå®¹å™¨ -->
    <div id="bookContainer" class="max-w-7xl mx-auto masonry-grid">
        <!-- åŠ¨æ€ç”Ÿæˆçš„ä¹¦å•å¡ç‰‡å°†åœ¨è¿™é‡Œ -->
    </div>

    <!-- ç©ºçŠ¶æ€æç¤º -->
    <div id="emptyState" class="hidden text-center py-20">
        <div class="text-6xl mb-4">ğŸ“–</div>
        <p class="text-white text-xl">è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•ä¹¦å•</p>
        <p class="text-white/60 mt-2">ç‚¹å‡»"åˆ›å»ºæ–°ä¹¦å•"å¼€å§‹è®°å½•æ‚¨çš„é˜…è¯»æ¸…å•</p>
    </div>

    <!-- ä¹¦å•ç¼–è¾‘æ¨¡æ€æ¡†ï¼ˆåˆ›å»º/ç¼–è¾‘ä¹¦å•ï¼‰ -->
    <div id="listModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="glass-effect rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden shadow-2xl modal-enter flex flex-col">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center bg-gradient-to-r from-purple-50 to-blue-50">
                <div>
                    <h2 id="listModalTitle" class="text-2xl font-bold gradient-text serif">åˆ›å»ºæ–°ä¹¦å•</h2>
                    <p class="text-sm text-gray-500 mt-1">ç®¡ç†æ‚¨çš„ä¹¦ç±æ”¶è—</p>
                </div>
                <button onclick="closeListModal()" class="text-gray-400 hover:text-gray-600 transition-colors p-2 hover:bg-gray-100 rounded-full">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-6">
                <form id="listForm" onsubmit="saveList(event)">
                    <input type="hidden" id="editListId">
                    
                    <!-- ä¹¦å•åŸºæœ¬ä¿¡æ¯ -->
                    <div class="grid md:grid-cols-2 gap-4 mb-6 bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å¹´æœˆ *</label>
                            <input type="month" id="listMonth" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition-all">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ä¹¦å•æ ‡é¢˜ *</label>
                            <input type="text" id="listTitle" required placeholder="ä¾‹å¦‚ï¼š2024å¹´æ˜¥å­£å¿…è¯»" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition-all">
                        </div>
                    </div>

                    <!-- ä¹¦ç±åˆ—è¡¨åŒºåŸŸ -->
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                                <span class="bg-purple-100 text-purple-700 px-2 py-1 rounded text-sm">ä¹¦ç±åˆ—è¡¨</span>
                                <span id="bookCount" class="text-sm text-gray-500 font-normal">(0 æœ¬)</span>
                            </h3>
                            <button type="button" onclick="addBookInput()" class="text-sm bg-purple-100 text-purple-700 px-3 py-1.5 rounded-lg hover:bg-purple-200 transition-colors flex items-center gap-1 font-medium">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                æ·»åŠ ä¸€æœ¬ä¹¦
                            </button>
                        </div>
                        
                        <div id="booksContainer" class="space-y-3">
                            <!-- åŠ¨æ€æ·»åŠ çš„ä¹¦ç±è¾“å…¥é¡¹ -->
                        </div>
                        
                        <div id="emptyBooksHint" class="text-center py-8 text-gray-400 border-2 border-dashed border-gray-200 rounded-xl">
                            <svg class="w-12 h-12 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                            <p>è¿˜æ²¡æœ‰æ·»åŠ ä¹¦ç±ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ </p>
                        </div>
                    </div>

                    <!-- æŒ‰é’®ç»„ -->
                    <div class="flex gap-3 justify-end pt-4 border-t border-gray-200 sticky bottom-0 bg-white/95 backdrop-blur-sm pb-2">
                        <button type="button" onclick="closeListModal()" class="px-6 py-2.5 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors font-medium">å–æ¶ˆ</button>
                        <button type="submit" class="px-6 py-2.5 rounded-lg bg-gradient-to-r from-purple-600 to-blue-600 text-white font-medium hover:shadow-lg hover:scale-105 transition-all flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            ä¿å­˜ä¹¦å•
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ä¸‹è½½é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="downloadModal" class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4 text-center serif">ç”Ÿæˆå›¾ç‰‡é¢„è§ˆ</h3>
            <div id="downloadPreview" class="mb-4 rounded-lg overflow-hidden shadow-lg border border-gray-200"></div>
            <div class="flex gap-3 justify-center">
                <button onclick="closeDownloadModal()" class="px-6 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors font-medium">å…³é—­</button>
                <a id="downloadLink" download="ä¹¦å•.png" class="px-6 py-2 rounded-lg bg-gradient-to-r from-purple-600 to-blue-600 text-white font-medium hover:shadow-lg cursor-pointer inline-block text-center transition-all hover:scale-105">
                    ä¸‹è½½å›¾ç‰‡
                </a>
            </div>
        </div>
    </div>

    <!-- å¯¼å…¥æ•°æ®æ¨¡æ€æ¡† -->
    <div id="importModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="glass-effect rounded-2xl w-full max-w-lg p-6 modal-enter">
            <h3 class="text-xl font-bold mb-4 gradient-text serif">å¯¼å…¥æ•°æ®</h3>
            <p class="text-sm text-gray-600 mb-4">è¯·ç²˜è´´ä¹‹å‰å¯¼å‡ºçš„ JSON æ•°æ®ï¼š</p>
            <textarea id="importDataInput" rows="10" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition-all font-mono text-sm" placeholder="åœ¨æ­¤ç²˜è´´ JSON æ•°æ®..."></textarea>
            <div class="flex gap-3 justify-end mt-4">
                <button onclick="closeImportModal()" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors">å–æ¶ˆ</button>
                <button onclick="confirmImport()" class="px-4 py-2 rounded-lg bg-gradient-to-r from-purple-600 to-blue-600 text-white font-medium hover:shadow-lg transition-all">ç¡®è®¤å¯¼å…¥</button>
            </div>
        </div>
    </div>

    <script>
        // æ•°æ®å­˜å‚¨ - ä½¿ç”¨å†…å­˜å­˜å‚¨ï¼Œé€šè¿‡å¯¼å‡º/å¯¼å…¥å®ç°è·¨è®¾å¤‡
        let bookLists = [];
        let currentEditingListId = null;
        let bookInputsCounter = 0;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // å°è¯•ä» localStorage åŠ è½½ï¼ˆä»…å½“å‰è®¾å¤‡ï¼‰
            const saved = localStorage.getItem('bookLists');
            if (saved) {
                try {
                    bookLists = JSON.parse(saved);
                } catch(e) {
                    console.error('åŠ è½½æ•°æ®å¤±è´¥');
                }
            }
            renderLists();
            
            // è®¾ç½®é»˜è®¤å¹´æœˆ
            const now = new Date();
            const yearMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            document.getElementById('listMonth').value = yearMonth;
        });

        // ä¿å­˜åˆ° localStorageï¼ˆå½“å‰è®¾å¤‡å¤‡ä»½ï¼‰
        function saveToStorage() {
            localStorage.setItem('bookLists', JSON.stringify(bookLists));
        }

        // æ¸²æŸ“ä¹¦å•åˆ—è¡¨
        function renderLists() {
            const container = document.getElementById('bookContainer');
            const filterMonth = document.getElementById('filterMonth').value;
            const emptyState = document.getElementById('emptyState');
            
            container.innerHTML = '';
            
            let filtered = bookLists;
            if (filterMonth) {
                filtered = bookLists.filter(list => list.month === filterMonth);
            }
            
            // æŒ‰å¹´æœˆé™åºæ’åº
            filtered.sort((a, b) => b.month.localeCompare(a.month));
            
            if (filtered.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            } else {
                emptyState.classList.add('hidden');
            }
            
            filtered.forEach(list => {
                const card = createListCard(list);
                container.appendChild(card);
            });
        }

        // åˆ›å»ºä¹¦å•å¡ç‰‡
        function createListCard(list) {
            const div = document.createElement('div');
            div.className = 'break-inside-avoid mb-6';
            
            const booksHtml = list.books.map((book, index) => `
                <div class="book-item bg-gray-50 rounded-lg p-3 mb-3 border border-gray-100 relative group">
                    <div class="flex items-start gap-3">
                        <span class="flex-shrink-0 w-6 h-6 bg-purple-100 text-purple-700 rounded-full flex items-center justify-center text-xs font-bold mt-0.5">${index + 1}</span>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-gray-800 text-sm leading-tight mb-1">${book.name}</h4>
                            <p class="text-xs text-gray-500 mb-1">ä½œè€…ï¼š${book.author}</p>
                            ${book.content ? `<p class="text-xs text-gray-600 mt-1 line-clamp-2">${book.content}</p>` : ''}
                            ${book.recommend ? `<p class="text-xs text-purple-600 mt-1 line-clamp-2 bg-purple-50 p-1.5 rounded italic">"${book.recommend}"</p>` : ''}
                        </div>
                    </div>
                    ${book.image ? `<img src="${book.image}" class="mt-2 w-full h-32 object-cover rounded-lg" alt="${book.name}">` : ''}
                </div>
            `).join('');
            
            div.innerHTML = `
                <div class="book-card bg-white rounded-2xl overflow-hidden shadow-lg" id="card-${list.id}">
                    <div class="bg-gradient-to-br from-purple-500 to-blue-600 p-4 text-white relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16"></div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-xs bg-white/20 backdrop-blur-md px-2 py-1 rounded-full">${list.month}</span>
                                <span class="text-xs bg-white/20 backdrop-blur-md px-2 py-1 rounded-full">${list.books.length} æœ¬ä¹¦</span>
                            </div>
                            <h3 class="text-xl font-bold serif leading-tight">${list.title}</h3>
                        </div>
                    </div>
                    
                    <div class="p-4">
                        <div class="space-y-1 mb-4 max-h-96 overflow-y-auto custom-scrollbar">
                            ${booksHtml}
                        </div>
                        
                        <div class="flex gap-2 pt-3 border-t border-gray-100">
                            <button onclick="editList('${list.id}')" class="flex-1 py-2 text-sm font-medium text-blue-600 hover:bg-blue-50 rounded-lg transition-colors flex items-center justify-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                ç¼–è¾‘
                            </button>
                            <button onclick="deleteList('${list.id}')" class="flex-1 py-2 text-sm font-medium text-red-600 hover:bg-red-50 rounded-lg transition-colors flex items-center justify-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                åˆ é™¤
                            </button>
                            <button onclick="downloadCard('${list.id}')" class="flex-1 py-2 text-sm font-medium text-purple-600 hover:bg-purple-50 rounded-lg transition-colors flex items-center justify-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                ä¸‹è½½
                            </button>
                        </div>
                    </div>
                </div>
            `;
            return div;
        }

        // åˆ›å»ºæ–°ä¹¦å•
        function createNewList() {
            currentEditingListId = null;
            document.getElementById('listModalTitle').textContent = 'åˆ›å»ºæ–°ä¹¦å•';
            document.getElementById('editListId').value = '';
            document.getElementById('listTitle').value = '';
            
            // é‡ç½®å¹´æœˆä¸ºå½“å‰
            const now = new Date();
            const yearMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            document.getElementById('listMonth').value = yearMonth;
            
            // æ¸…ç©ºä¹¦ç±åˆ—è¡¨ï¼Œæ·»åŠ ä¸€ä¸ªç©ºè¾“å…¥
            document.getElementById('booksContainer').innerHTML = '';
            bookInputsCounter = 0;
            addBookInput();
            
            updateBookCount();
            openListModal();
        }

        // ç¼–è¾‘ä¹¦å•
        function editList(id) {
            const list = bookLists.find(l => l.id === id);
            if (!list) return;
            
            currentEditingListId = id;
            document.getElementById('listModalTitle').textContent = 'ç¼–è¾‘ä¹¦å•';
            document.getElementById('editListId').value = id;
            document.getElementById('listMonth').value = list.month;
            document.getElementById('listTitle').value = list.title;
            
            // åŠ è½½ä¹¦ç±åˆ—è¡¨
            const container = document.getElementById('booksContainer');
            container.innerHTML = '';
            bookInputsCounter = 0;
            
            list.books.forEach(book => {
                addBookInput(book);
            });
            
            updateBookCount();
            openListModal();
        }

        // æ·»åŠ ä¹¦ç±è¾“å…¥é¡¹ï¼ˆæ”¯æŒä¼ å…¥å·²æœ‰æ•°æ®ï¼‰
        function addBookInput(bookData = null) {
            const container = document.getElementById('booksContainer');
            const emptyHint = document.getElementById('emptyBooksHint');
            
            if (emptyHint) emptyHint.style.display = 'none';
            
            bookInputsCounter++;
            const id = bookInputsCounter;
            
            const div = document.createElement('div');
            div.className = 'book-input-item bg-white border-2 border-purple-100 rounded-xl p-4 relative group hover:border-purple-300 transition-all';
            div.id = `book-input-${id}`;
            
            div.innerHTML = `
                <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-100">
                    <span class="text-sm font-bold text-purple-700 flex items-center gap-2">
                        <span class="w-6 h-6 bg-purple-100 rounded-full flex items-center justify-center text-xs">${id}</span>
                        ä¹¦ç± #${id}
                    </span>
                    <button type="button" onclick="removeBookInput(${id})" class="text-gray-400 hover:text-red-500 transition-colors p-1 hover:bg-red-50 rounded" title="åˆ é™¤æ­¤ä¹¦">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
                
                <div class="grid md:grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">ä¹¦å *</label>
                        <input type="text" class="book-name w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition-all text-sm" placeholder="è¾“å…¥ä¹¦å" value="${bookData ? bookData.name : ''}" required>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">ä½œè€… *</label>
                        <input type="text" class="book-author w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition-all text-sm" placeholder="è¾“å…¥ä½œè€…" value="${bookData ? bookData.author : ''}" required>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="block text-xs font-medium text-gray-600 mb-1">å†…å®¹ç®€ä»‹</label>
                    <textarea class="book-content w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition-all text-sm resize-none" rows="2" placeholder="è¿™æœ¬ä¹¦è®²äº†ä»€ä¹ˆ...">${bookData ? bookData.content : ''}</textarea>
                </div>
                
                <div class="mb-3">
                    <label class="block text-xs font-medium text-gray-600 mb-1">æ¨èç†ç”±</label>
                    <textarea class="book-recommend w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition-all text-sm resize-none" rows="2" placeholder="ä¸ºä»€ä¹ˆæ¨èè¿™æœ¬ä¹¦...">${bookData ? bookData.recommend : ''}</textarea>
                </div>
                
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">å°é¢å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰</label>
                    <div class="relative">
                        <input type="file" class="book-image-input hidden" accept="image/*" onchange="previewBookImage(this, ${id})">
                        <label class="book-image-label flex items-center justify-center w-full h-24 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-purple-500 hover:bg-purple-50 transition-all group ${bookData && bookData.image ? 'hidden' : ''}">
                            <div class="text-center">
                                <svg class="mx-auto h-8 w-8 text-gray-400 group-hover:text-purple-500 transition-colors" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                                <p class="mt-1 text-xs text-gray-600">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</p>
                            </div>
                        </label>
                        <div class="book-image-preview ${bookData && bookData.image ? '' : 'hidden'} relative h-24 rounded-lg overflow-hidden">
                            <img class="w-full h-full object-cover" src="${bookData ? bookData.image : ''}">
                            <button type="button" onclick="removeBookImage(${id})" class="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 hover:bg-red-600 transition-colors shadow-md">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(div);
            updateBookCount();
            
            // æ»šåŠ¨åˆ°æ–°æ·»åŠ çš„ä¹¦ç±
            div.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // ç§»é™¤ä¹¦ç±è¾“å…¥é¡¹
        function removeBookInput(id) {
            const element = document.getElementById(`book-input-${id}`);
            if (element) {
                element.remove();
                updateBookCount();
                
                // å¦‚æœæ²¡æœ‰ä¹¦ç±äº†ï¼Œæ˜¾ç¤ºæç¤º
                const container = document.getElementById('booksContainer');
                if (container.children.length === 0) {
                    document.getElementById('emptyBooksHint').style.display = 'block';
                }
                
                // é‡æ–°ç¼–å·
                updateBookNumbers();
            }
        }

        // æ›´æ–°ä¹¦ç±ç¼–å·
        function updateBookNumbers() {
            const items = document.querySelectorAll('.book-input-item');
            items.forEach((item, index) => {
                const num = index + 1;
                const badge = item.querySelector('.bg-purple-100');
                const label = item.querySelector('.text-purple-700');
                if (badge) badge.textContent = num;
                if (label) label.innerHTML = `<span class="w-6 h-6 bg-purple-100 rounded-full flex items-center justify-center text-xs">${num}</span> ä¹¦ç± #${num}`;
            });
            bookInputsCounter = items.length;
        }

        // æ›´æ–°ä¹¦ç±è®¡æ•°
        function updateBookCount() {
            const count = document.querySelectorAll('.book-input-item').length;
            document.getElementById('bookCount').textContent = `(${count} æœ¬)`;
        }

        // é¢„è§ˆä¹¦ç±å›¾ç‰‡
        function previewBookImage(input, id) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const container = input.closest('.relative');
                    container.querySelector('.book-image-label').classList.add('hidden');
                    const preview = container.querySelector('.book-image-preview');
                    preview.classList.remove('hidden');
                    preview.querySelector('img').src = e.target.result;
                    preview.dataset.imageBase64 = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        // ç§»é™¤ä¹¦ç±å›¾ç‰‡
        function removeBookImage(id) {
            const container = document.getElementById(`book-input-${id}`);
            const input = container.querySelector('.book-image-input');
            const label = container.querySelector('.book-image-label');
            const preview = container.querySelector('.book-image-preview');
            
            input.value = '';
            label.classList.remove('hidden');
            preview.classList.add('hidden');
            delete preview.dataset.imageBase64;
        }

        // ä¿å­˜ä¹¦å•
        function saveList(event) {
            event.preventDefault();
            
            const month = document.getElementById('listMonth').value;
            const title = document.getElementById('listTitle').value;
            
            // æ”¶é›†æ‰€æœ‰ä¹¦ç±æ•°æ®
            const books = [];
            const bookItems = document.querySelectorAll('.book-input-item');
            
            bookItems.forEach(item => {
                const name = item.querySelector('.book-name').value.trim();
                const author = item.querySelector('.book-author').value.trim();
                const content = item.querySelector('.book-content').value.trim();
                const recommend = item.querySelector('.book-recommend').value.trim();
                const previewDiv = item.querySelector('.book-image-preview');
                const image = previewDiv && !previewDiv.classList.contains('hidden') ? previewDiv.dataset.imageBase64 || previewDiv.querySelector('img').src : null;
                
                if (name && author) {
                    books.push({
                        name,
                        author,
                        content,
                        recommend,
                        image
                    });
                }
            });
            
            if (books.length === 0) {
                alert('è¯·è‡³å°‘æ·»åŠ ä¸€æœ¬ä¹¦ç±');
                return;
            }
            
            const listData = {
                id: currentEditingListId || Date.now().toString(),
                month,
                title,
                books,
                updatedAt: new Date().toISOString()
            };
            
            if (currentEditingListId) {
                const index = bookLists.findIndex(l => l.id === currentEditingListId);
                if (index !== -1) {
                    bookLists[index] = listData;
                }
            } else {
                bookLists.push(listData);
            }
            
            saveToStorage();
            renderLists();
            closeListModal();
        }

        // åˆ é™¤ä¹¦å•
        function deleteList(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¹¦å•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                bookLists = bookLists.filter(l => l.id !== id);
                saveToStorage();
                renderLists();
            }
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            if (bookLists.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
                return;
            }
            
            const dataStr = JSON.stringify(bookLists, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ä¹¦å•å¤‡ä»½_${new Date().toLocaleDateString()}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            // åŒæ—¶å¤åˆ¶åˆ°å‰ªè´´æ¿
            navigator.clipboard.writeText(dataStr).then(() => {
                alert('æ•°æ®å·²å¯¼å‡ºå¹¶å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼è¯·å¦¥å–„ä¿å­˜ JSON æ–‡ä»¶æˆ–æ–‡æœ¬ï¼Œä»¥ä¾¿åœ¨å…¶ä»–è®¾å¤‡å¯¼å…¥ã€‚');
            }).catch(() => {
                alert('æ•°æ®å·²å¯¼å‡ºï¼è¯·ä¿å­˜ JSON æ–‡ä»¶ä»¥ä¾¿åœ¨å…¶ä»–è®¾å¤‡ä½¿ç”¨ã€‚');
            });
        }

        // å¯¼å…¥æ•°æ®
        function importData() {
            document.getElementById('importModal').classList.remove('hidden');
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.add('hidden');
            document.getElementById('importDataInput').value = '';
        }

        function confirmImport() {
            const input = document.getElementById('importDataInput').value.trim();
            if (!input) {
                alert('è¯·è¾“å…¥æ•°æ®');
                return;
            }
            
            try {
                const data = JSON.parse(input);
                if (!Array.isArray(data)) {
                    throw new Error('æ•°æ®æ ¼å¼é”™è¯¯');
                }
                
                // éªŒè¯æ•°æ®æ ¼å¼
                const isValid = data.every(item => 
                    item.id && item.month && item.title && Array.isArray(item.books)
                );
                
                if (!isValid) {
                    throw new Error('æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                }
                
                if (confirm(`ç¡®å®šè¦å¯¼å…¥ ${data.length} ä¸ªä¹¦å•å—ï¼Ÿè¿™å°†è¦†ç›–å½“å‰çš„æ‰€æœ‰æ•°æ®ã€‚`)) {
                    bookLists = data;
                    saveToStorage();
                    renderLists();
                    closeImportModal();
                    alert('å¯¼å…¥æˆåŠŸï¼');
                }
            } catch (e) {
                alert('å¯¼å…¥å¤±è´¥ï¼š' + e.message);
            }
        }

        // ä¸‹è½½å¡ç‰‡ä¸ºå›¾ç‰‡
        async function downloadCard(id) {
            const list = bookLists.find(l => l.id === id);
            if (!list) return;
            
            // åˆ›å»ºä¸“é—¨ç”¨äºä¸‹è½½çš„å¡ç‰‡å…‹éš†
            const clone = document.createElement('div');
            clone.style.width = '400px';
            clone.style.background = 'white';
            clone.style.padding = '0';
            clone.style.borderRadius = '16px';
            clone.style.overflow = 'hidden';
            clone.style.boxShadow = '0 25px 50px -12px rgba(0, 0, 0, 0.25)';
            
            const booksHtml = list.books.map((book, index) => `
                <div style="margin-bottom: 16px; padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #f3f4f6;">
                    <div style="display: flex; gap: 12px; margin-bottom: 8px;">
                        <div style="width: 24px; height: 24px; background: #ede9fe; color: #7c3aed; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; flex-shrink: 0;">${index + 1}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: #1f2937; font-size: 14px; margin-bottom: 4px;">${book.name}</div>
                            <div style="font-size: 12px; color: #6b7280;">ä½œè€…ï¼š${book.author}</div>
                        </div>
                    </div>
                    ${book.content ? `<div style="font-size: 12px; color: #4b5563; margin-top: 8px; line-height: 1.5;">${book.content}</div>` : ''}
                    ${book.recommend ? `<div style="font-size: 12px; color: #7c3aed; margin-top: 8px; padding: 8px; background: #f5f3ff; border-radius: 6px; font-style: italic;">"${book.recommend}"</div>` : ''}
                    ${book.image ? `<img src="${book.image}" style="width: 100%; height: 120px; object-fit: cover; border-radius: 6px; margin-top: 8px;">` : ''}
                </div>
            `).join('');
            
            clone.innerHTML = `
                <div style="background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%); padding: 24px; color: white; position: relative;">
                    <div style="font-size: 12px; opacity: 0.9; margin-bottom: 8px;">${list.month} Â· å…± ${list.books.length} æœ¬</div>
                    <div style="font-size: 24px; font-weight: bold; font-family: serif;">${list.title}</div>
                </div>
                <div style="padding: 20px; background: white;">
                    ${booksHtml}
                </div>
                <div style="padding: 16px; text-align: center; font-size: 11px; color: #9ca3af; border-top: 1px solid #f3f4f6;">
                    ç”Ÿæˆäº ${new Date().toLocaleDateString()} Â· æˆ‘çš„ä¹¦å•
                </div>
            `;
            
            document.body.appendChild(clone);
            
            try {
                const canvas = await html2canvas(clone, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    logging: false
                });
                
                const image = canvas.toDataURL('image/png');
                
                const preview = document.getElementById('downloadPreview');
                preview.innerHTML = `<img src="${image}" style="width: 100%; display: block;">`;
                
                const link = document.getElementById('downloadLink');
                link.href = image;
                link.download = `${list.title}_${list.month}.png`;
                
                document.getElementById('downloadModal').classList.remove('hidden');
                
            } catch (err) {
                console.error('ç”Ÿæˆå›¾ç‰‡å¤±è´¥:', err);
                alert('ç”Ÿæˆå›¾ç‰‡å¤±è´¥ï¼Œè¯·é‡è¯•');
            } finally {
                document.body.removeChild(clone);
            }
        }

        function closeDownloadModal() {
            document.getElementById('downloadModal').classList.add('hidden');
        }

        // æ¨¡æ€æ¡†æ§åˆ¶
        function openListModal() {
            document.getElementById('listModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeListModal() {
            document.getElementById('listModal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        // ç­›é€‰åŠŸèƒ½
        document.getElementById('filterMonth').addEventListener('change', renderLists);

        function clearFilter() {
            document.getElementById('filterMonth').value = '';
            renderLists();
        }

        // ç‚¹å‡»å¤–éƒ¨å…³é—­æ¨¡æ€æ¡†
        document.getElementById('listModal').addEventListener('click', function(e) {
            if (e.target === this) closeListModal();
        });

        document.getElementById('importModal').addEventListener('click', function(e) {
            if (e.target === this) closeImportModal();
        });

        document.getElementById('downloadModal').addEventListener('click', function(e) {
            if (e.target === this) closeDownloadModal();
        });
    </script>
</body>
</html>