<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¹¦å•åˆ†äº«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Noto+Sans+SC:wght@300;400;500;700&family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            /* ä¸é¦–é¡µå®Œå…¨ä¸€è‡´çš„èƒŒæ™¯è‰² */
            background-color: #f0f7ff;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        .serif {
            font-family: 'Noto Serif SC', serif;
        }
        .masonry-grid {
            column-count: 1;
            column-gap: 1.5rem;
        }
        @media (min-width: 640px) {
            .masonry-grid { column-count: 2; }
        }
        @media (min-width: 1024px) {
            .masonry-grid { column-count: 3; }
        }
        @media (min-width: 1280px) {
            .masonry-grid { column-count: 4; }
        }
        .break-inside-avoid {
            break-inside: avoid;
            page-break-inside: avoid;
        }
        .book-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .book-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        .modal-enter {
            animation: modalEnter 0.3s ease-out;
        }
        @keyframes modalEnter {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .book-item {
            transition: all 0.2s ease;
        }
        .book-item:hover {
            background-color: rgba(139, 92, 246, 0.05);
        }
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: #c4b5fd;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a78bfa;
        }
        
        /* å¯¼èˆªæ æ ·å¼ - ä¸é¦–é¡µä¿æŒä¸€è‡´ */
        .navbar {
            background-color: #4a90e2;
            padding: 12px 0;
            margin-bottom: 20px;
            border-radius: 8px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            margin-top: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            gap: 30px;
        }
        
        .nav-link {
            color: white;
            text-decoration: none;
            font-size: 18px;
            font-weight: 500;
            padding: 10px 20px;
            border-radius: 6px;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .nav-link.active {
            background-color: #2c6cb0;
        }
        
        /* ä¸»å®¹å™¨ */
        .main-wrapper {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px 40px;
        }
        
        /* ä¿®å¤æ–‡ä»¶ä¸Šä¼ æŒ‰é’®æ ·å¼ */
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
            z-index: 10;
        }
        
        .upload-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 120px;
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s;
            background-color: #f9fafb;
        }
        
        .upload-label:hover {
            border-color: #8b5cf6;
            background-color: #f5f3ff;
        }
        
        .image-preview-container {
            position: relative;
            width: 100%;
            height: 120px;
            border-radius: 0.5rem;
            overflow: hidden;
            display: none;
        }
        
        .image-preview-container.active {
            display: block;
        }
        
        .image-preview-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .remove-image-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background-color: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 20;
            transition: background-color 0.2s;
        }
        
        .remove-image-btn:hover {
            background-color: #dc2626;
        }

        /* å°ºå¯¸æç¤ºæ ·å¼ */
        .size-hint {
            font-size: 11px;
            color: #6b7280;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* ä¸‹è½½é¢„è§ˆæ¨¡æ€æ¡†ä¸­çš„å›¾ç‰‡æ ·å¼ */
        #downloadPreview img {
            max-width: 100%;
            height: auto;
            display: block;
        }

        /* ä¹¦ç±ä¿¡æ¯æ ‡ç­¾æ ·å¼ */
        .info-label {
            font-size: 11px;
            color: #6b7280;
            font-weight: 600;
            margin-bottom: 2px;
            display: block;
        }
        
        .info-label-purple {
            color: #7c3aed;
        }

        /* æ–‡ä»¶å¯¼å…¥åŒºåŸŸæ ·å¼ */
        .file-import-area {
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            transition: all 0.3s;
            background-color: #f9fafb;
            cursor: pointer;
        }
        
        .file-import-area:hover {
            border-color: #8b5cf6;
            background-color: #f5f3ff;
        }
        
        .file-import-area.dragover {
            border-color: #8b5cf6;
            background-color: #ede9fe;
        }
    </style>
</head>
<body>

    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-link">
                <i class="fas fa-home"></i>ä¸»é¡µ
            </a>
            <a href="booklist.html" class="nav-link active">
                <i class="fas fa-pen-fancy"></i>ä¹¦å•åˆ†äº«
            </a>
            <a href="Englishwordslearning.html" class="nav-link active">
                <i class="fas fa-pen-fancy"></i>è‹±è¯­é«˜é¢‘1000è¯å­¦ä¹ 
            </a>
        </div>
    </nav>

    <div class="main-wrapper">
        <!-- å¤´éƒ¨åŒºåŸŸ -->
        <header class="mb-8 text-center">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mb-4 serif tracking-wide">
                ğŸ“š æˆ‘çš„ä¹¦å•
            </h1>
            <p class="text-gray-600 text-lg mb-6">è®°å½•é˜…è¯»æ—¶å…‰ï¼Œç®¡ç†æ‚¨çš„ä¹¦ç±æ”¶è—</p>
            
            <!-- ç­›é€‰å™¨å’Œä¸»æ·»åŠ æŒ‰é’® -->
            <div class="glass-effect rounded-2xl p-4 inline-flex flex-wrap gap-4 items-center justify-center shadow-xl">
                <div class="flex items-center gap-2">
                    <label class="text-gray-700 font-medium">ç­›é€‰å¹´æœˆï¼š</label>
                    <input type="month" id="filterMonth" class="px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition-all">
                    <button onclick="clearFilter()" class="px-4 py-2 text-sm text-purple-600 hover:text-purple-800 font-medium transition-colors">
                        æ¸…é™¤ç­›é€‰
                    </button>
                </div>
                <div class="h-8 w-px bg-gray-300 hidden md:block"></div>
                <button onclick="createNewList()" class="bg-gradient-to-r from-purple-600 to-blue-600 text-white px-6 py-2 rounded-lg font-medium hover:shadow-lg hover:scale-105 transition-all flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    åˆ›å»ºæ–°ä¹¦å•
                </button>
                <button onclick="exportData()" class="bg-white text-purple-600 border-2 border-purple-600 px-4 py-2 rounded-lg font-medium hover:bg-purple-50 transition-all flex items-center gap-2 text-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                    å¯¼å‡ºæ•°æ®
                </button>
                <button onclick="importData()" class="bg-white text-blue-600 border-2 border-blue-600 px-4 py-2 rounded-lg font-medium hover:bg-blue-50 transition-all flex items-center gap-2 text-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    å¯¼å…¥æ•°æ®
                </button>
            </div>
        </header>

        <!-- ä¹¦å•ç€‘å¸ƒæµå®¹å™¨ -->
        <div id="bookContainer" class="masonry-grid">
            <!-- åŠ¨æ€ç”Ÿæˆçš„ä¹¦å•å¡ç‰‡å°†åœ¨è¿™é‡Œ -->
        </div>

        <!-- ç©ºçŠ¶æ€æç¤º -->
        <div id="emptyState" class="hidden text-center py-20">
            <div class="text-6xl mb-4">ğŸ“–</div>
            <p class="text-gray-600 text-xl">è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•ä¹¦å•</p>
            <p class="text-gray-500 mt-2">ç‚¹å‡»"åˆ›å»ºæ–°ä¹¦å•"å¼€å§‹è®°å½•æ‚¨çš„é˜…è¯»æ¸…å•</p>
        </div>
    </div>

    <!-- ä¹¦å•ç¼–è¾‘æ¨¡æ€æ¡†ï¼ˆåˆ›å»º/ç¼–è¾‘ä¹¦å•ï¼‰ -->
    <div id="listModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="glass-effect rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden shadow-2xl modal-enter flex flex-col">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center bg-gradient-to-r from-purple-50 to-blue-50">
                <div>
                    <h2 id="listModalTitle" class="text-2xl font-bold gradient-text serif">åˆ›å»ºæ–°ä¹¦å•</h2>
                    <p class="text-sm text-gray-500 mt-1">ç®¡ç†æ‚¨çš„ä¹¦ç±æ”¶è—</p>
                </div>
                <button onclick="closeListModal()" class="text-gray-400 hover:text-gray-600 transition-colors p-2 hover:bg-gray-100 rounded-full">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-6">
                <form id="listForm" onsubmit="saveList(event)">
                    <input type="hidden" id="editListId">
                    
                    <!-- ä¹¦å•åŸºæœ¬ä¿¡æ¯ -->
                    <div class="grid md:grid-cols-2 gap-4 mb-6 bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å¹´æœˆ *</label>
                            <input type="month" id="listMonth" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition-all">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ä¹¦å•æ ‡é¢˜ *</label>
                            <input type="text" id="listTitle" required placeholder="ä¾‹å¦‚ï¼š2024å¹´æ˜¥å­£å¿…è¯»" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition-all">
                        </div>
                    </div>

                    <!-- ä¹¦ç±åˆ—è¡¨åŒºåŸŸ -->
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                                <span class="bg-purple-100 text-purple-700 px-2 py-1 rounded text-sm">ä¹¦ç±åˆ—è¡¨</span>
                                <span id="bookCount" class="text-sm text-gray-500 font-normal">(0 æœ¬)</span>
                            </h3>
                            <button type="button" onclick="addBookInput()" class="text-sm bg-purple-100 text-purple-700 px-3 py-1.5 rounded-lg hover:bg-purple-200 transition-colors flex items-center gap-1 font-medium">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                æ·»åŠ ä¸€æœ¬ä¹¦
                            </button>
                        </div>
                        
                        <div id="booksContainer" class="space-y-3">
                            <!-- åŠ¨æ€æ·»åŠ çš„ä¹¦ç±è¾“å…¥é¡¹ -->
                        </div>
                        
                        <div id="emptyBooksHint" class="text-center py-8 text-gray-400 border-2 border-dashed border-gray-200 rounded-xl">
                            <svg class="w-12 h-12 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                            <p>è¿˜æ²¡æœ‰æ·»åŠ ä¹¦ç±ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ </p>
                        </div>
                    </div>

                    <!-- æŒ‰é’®ç»„ -->
                    <div class="flex gap-3 justify-end pt-4 border-t border-gray-200 sticky bottom-0 bg-white/95 backdrop-blur-sm pb-2">
                        <button type="button" onclick="closeListModal()" class="px-6 py-2.5 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors font-medium">å–æ¶ˆ</button>
                        <button type="submit" class="px-6 py-2.5 rounded-lg bg-gradient-to-r from-purple-600 to-blue-600 text-white font-medium hover:shadow-lg hover:scale-105 transition-all flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            ä¿å­˜ä¹¦å•
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ä¸‹è½½é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="downloadModal" class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4 text-center serif">ç”Ÿæˆå›¾ç‰‡é¢„è§ˆ</h3>
            <div id="downloadPreview" class="mb-4 rounded-lg overflow-hidden shadow-lg border border-gray-200"></div>
            <div class="flex gap-3 justify-center">
                <button onclick="closeDownloadModal()" class="px-6 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors font-medium">å…³é—­</button>
                <a id="downloadLink" download="ä¹¦å•.png" class="px-6 py-2 rounded-lg bg-gradient-to-r from-purple-600 to-blue-600 text-white font-medium hover:shadow-lg cursor-pointer inline-block text-center transition-all hover:scale-105">
                    ä¸‹è½½å›¾ç‰‡
                </a>
            </div>
        </div>
    </div>

    <!-- å¯¼å…¥æ•°æ®æ¨¡æ€æ¡† - æ”¯æŒæ–‡ä»¶é€‰æ‹© -->
    <div id="importModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="glass-effect rounded-2xl w-full max-w-lg p-6 modal-enter">
            <h3 class="text-xl font-bold mb-4 gradient-text serif">å¯¼å…¥æ•°æ®</h3>
            
            <!-- æ–‡ä»¶é€‰æ‹©åŒºåŸŸ -->
            <div class="file-import-area mb-4" id="fileImportArea" onclick="document.getElementById('importFileInput').click()">
                <input type="file" id="importFileInput" accept=".json" class="hidden" onchange="handleFileImport(this)">
                <svg class="w-12 h-12 mx-auto mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <p class="text-sm text-gray-600 mb-1">ç‚¹å‡»é€‰æ‹© JSON æ–‡ä»¶</p>
                <p class="text-xs text-gray-400">æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</p>
            </div>
            
            <div class="relative mb-4">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-2 bg-white text-gray-500">æˆ–è€…</span>
                </div>
            </div>
            
            <p class="text-sm text-gray-600 mb-2">ç›´æ¥ç²˜è´´ JSON æ•°æ®ï¼š</p>
            <textarea id="importDataInput" rows="6" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition-all font-mono text-sm" placeholder="åœ¨æ­¤ç²˜è´´ JSON æ•°æ®..."></textarea>
            
            <div class="flex gap-3 justify-end mt-4">
                <button onclick="closeImportModal()" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors">å–æ¶ˆ</button>
                <button onclick="confirmImport()" class="px-4 py-2 rounded-lg bg-gradient-to-r from-purple-600 to-blue-600 text-white font-medium hover:shadow-lg transition-all">ç¡®è®¤å¯¼å…¥</button>
            </div>
        </div>
    </div>

    <script>
        // å›¾ç‰‡å‹ç¼©é…ç½®
        const IMAGE_CONFIG = {
            maxWidth: 800,
            maxHeight: 600,
            quality: 0.8,
            maxSizeMB: 1
        };

        // æ•°æ®å­˜å‚¨ - ä½¿ç”¨å†…å­˜å­˜å‚¨ï¼Œé€šè¿‡å¯¼å‡º/å¯¼å…¥å®ç°è·¨è®¾å¤‡
        let bookLists = [];
        let currentEditingListId = null;
        let bookInputsCounter = 0;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // å°è¯•ä» localStorage åŠ è½½ï¼ˆä»…å½“å‰è®¾å¤‡ï¼‰
            const saved = localStorage.getItem('bookLists');
            if (saved) {
                try {
                    bookLists = JSON.parse(saved);
                } catch(e) {
                    console.error('åŠ è½½æ•°æ®å¤±è´¥');
                }
            }
            renderLists();
            
            // è®¾ç½®é»˜è®¤å¹´æœˆ
            const now = new Date();
            const yearMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            document.getElementById('listMonth').value = yearMonth;
            
            // è®¾ç½®æ‹–æ‹½å¯¼å…¥
            setupDragAndDrop();
        });

        // ä¿å­˜åˆ° localStorageï¼ˆå½“å‰è®¾å¤‡å¤‡ä»½ï¼‰
        function saveToStorage() {
            localStorage.setItem('bookLists', JSON.stringify(bookLists));
        }

        // è®¾ç½®æ‹–æ‹½å¯¼å…¥
        function setupDragAndDrop() {
            const dropZone = document.getElementById('fileImportArea');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.add('dragover');
                }, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.remove('dragover');
                }, false);
            });
            
            dropZone.addEventListener('drop', handleDrop, false);
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0 && files[0].name.endsWith('.json')) {
                handleFileImport({ files: files });
            } else {
                alert('è¯·é€‰æ‹© JSON æ–‡ä»¶');
            }
        }

        // å¤„ç†æ–‡ä»¶å¯¼å…¥
        function handleFileImport(input) {
            const file = input.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.json')) {
                alert('è¯·é€‰æ‹© JSON æ ¼å¼çš„æ–‡ä»¶');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    document.getElementById('importDataInput').value = content;
                    
                    // è‡ªåŠ¨ç¡®è®¤å¯¼å…¥
                    if (confirm(`ç¡®å®šè¦å¯¼å…¥æ–‡ä»¶ "${file.name}" å—ï¼Ÿè¿™å°†è¦†ç›–å½“å‰çš„æ‰€æœ‰æ•°æ®ã€‚`)) {
                        processImportData(content);
                    }
                } catch (error) {
                    alert('è¯»å–æ–‡ä»¶å¤±è´¥ï¼š' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // å‹ç¼©å›¾ç‰‡
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        let width = img.width;
                        let height = img.height;
                        
                        // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
                        if (width > height) {
                            if (width > IMAGE_CONFIG.maxWidth) {
                                height *= IMAGE_CONFIG.maxWidth / width;
                                width = IMAGE_CONFIG.maxWidth;
                            }
                        } else {
                            if (height > IMAGE_CONFIG.maxHeight) {
                                width *= IMAGE_CONFIG.maxHeight / height;
                                height = IMAGE_CONFIG.maxHeight;
                            }
                        }
                        
                        // åˆ›å»º canvas
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        
                        // ä½¿ç”¨æ›´å¥½çš„å›¾åƒè´¨é‡
                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';
                        
                        // ç»˜åˆ¶å›¾ç‰‡
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // è½¬æ¢ä¸º base64
                        const compressedBase64 = canvas.toDataURL('image/jpeg', IMAGE_CONFIG.quality);
                        
                        // æ£€æŸ¥æ–‡ä»¶å¤§å°
                        const sizeInMB = (compressedBase64.length * 0.75) / (1024 * 1024);
                        if (sizeInMB > IMAGE_CONFIG.maxSizeMB) {
                            // å¦‚æœè¿˜æ˜¯å¤ªå¤§ï¼Œè¿›ä¸€æ­¥å‹ç¼©
                            const furtherCompressed = canvas.toDataURL('image/jpeg', 0.6);
                            resolve(furtherCompressed);
                        } else {
                            resolve(compressedBase64);
                        }
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // æ¸²æŸ“ä¹¦å•åˆ—è¡¨
        function renderLists() {
            const container = document.getElementById('bookContainer');
            const filterMonth = document.getElementById('filterMonth').value;
            const emptyState = document.getElementById('emptyState');
            
            container.innerHTML = '';
            
            let filtered = bookLists;
            if (filterMonth) {
                filtered = bookLists.filter(list => list.month === filterMonth);
            }
            
            // æŒ‰å¹´æœˆé™åºæ’åº
            filtered.sort((a, b) => b.month.localeCompare(a.month));
            
            if (filtered.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            } else {
                emptyState.classList.add('hidden');
            }
            
            filtered.forEach(list => {
                const card = createListCard(list);
                container.appendChild(card);
            });
        }

        // åˆ›å»ºä¹¦å•å¡ç‰‡ - å¸¦æŠ¬å¤´æ ‡ç­¾ç‰ˆæœ¬
        function createListCard(list) {
            const div = document.createElement('div');
            div.className = 'break-inside-avoid mb-6';
            
            const booksHtml = list.books.map((book, index) => {
                // æ„å»ºå†…å®¹åŒºåŸŸï¼Œå¸¦æŠ¬å¤´æ ‡ç­¾
                let contentHtml = '';
                if (book.content && book.content.trim()) {
                    contentHtml = `
                        <div class="mt-2">
                            <span class="info-label">å†…å®¹ç®€ä»‹ï¼š</span>
                            <p class="text-xs text-gray-600 leading-relaxed">${book.content}</p>
                        </div>
                    `;
                }
                
                let recommendHtml = '';
                if (book.recommend && book.recommend.trim()) {
                    recommendHtml = `
                        <div class="mt-2">
                            <span class="info-label info-label-purple">æ¨èç†ç”±ï¼š</span>
                            <p class="text-xs text-purple-600 bg-purple-50 p-2 rounded italic leading-relaxed">"${book.recommend}"</p>
                        </div>
                    `;
                }
                
                let imageHtml = '';
                if (book.image) {
                    imageHtml = `<img src="${book.image}" class="mt-2 w-full h-32 object-cover rounded-lg" alt="${book.name}" loading="lazy">`;
                }
                
                return `
                    <div class="book-item bg-gray-50 rounded-lg p-3 mb-3 border border-gray-100 relative group">
                        <div class="flex items-start gap-3">
                            <span class="flex-shrink-0 w-6 h-6 bg-purple-100 text-purple-700 rounded-full flex items-center justify-center text-xs font-bold mt-0.5">${index + 1}</span>
                            <div class="flex-1 min-w-0">
                                <div class="mb-1">
                                    <span class="info-label">ä¹¦åï¼š</span>
                                    <h4 class="font-bold text-gray-800 text-sm leading-tight">${book.name}</h4>
                                </div>
                                <div>
                                    <span class="info-label">ä½œè€…ï¼š</span>
                                    <p class="text-xs text-gray-500">${book.author}</p>
                                </div>
                                ${contentHtml}
                                ${recommendHtml}
                            </div>
                        </div>
                        ${imageHtml}
                    </div>
                `;
            }).join('');
            
            div.innerHTML = `
                <div class="book-card bg-white rounded-2xl overflow-hidden shadow-lg" id="card-${list.id}">
                    <div class="bg-gradient-to-br from-purple-500 to-blue-600 p-4 text-white relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16"></div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-xs bg-white/20 backdrop-blur-md px-2 py-1 rounded-full">${list.month}</span>
                                <span class="text-xs bg-white/20 backdrop-blur-md px-2 py-1 rounded-full">${list.books.length} æœ¬ä¹¦</span>
                            </div>
                            <h3 class="text-xl font-bold serif leading-tight">${list.title}</h3>
                        </div>
                    </div>
                    
                    <div class="p-4">
                        <div class="space-y-1 mb-4 max-h-96 overflow-y-auto custom-scrollbar">
                            ${booksHtml}
                        </div>
                        
                        <div class="flex gap-2 pt-3 border-t border-gray-100">
                            <button onclick="editList('${list.id}')" class="flex-1 py-2 text-sm font-medium text-blue-600 hover:bg-blue-50 rounded-lg transition-colors flex items-center justify-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                ç¼–è¾‘
                            </button>
                            <button onclick="deleteList('${list.id}')" class="flex-1 py-2 text-sm font-medium text-red-600 hover:bg-red-50 rounded-lg transition-colors flex items-center justify-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                åˆ é™¤
                            </button>
                            <button onclick="downloadCard('${list.id}')" class="flex-1 py-2 text-sm font-medium text-purple-600 hover:bg-purple-50 rounded-lg transition-colors flex items-center justify-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                ä¸‹è½½
                            </button>
                        </div>
                    </div>
                </div>
            `;
            return div;
        }

        // åˆ›å»ºæ–°ä¹¦å•
        function createNewList() {
            currentEditingListId = null;
            document.getElementById('listModalTitle').textContent = 'åˆ›å»ºæ–°ä¹¦å•';
            document.getElementById('editListId').value = '';
            document.getElementById('listTitle').value = '';
            
            // é‡ç½®å¹´æœˆä¸ºå½“å‰
            const now = new Date();
            const yearMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            document.getElementById('listMonth').value = yearMonth;
            
            // æ¸…ç©ºä¹¦ç±åˆ—è¡¨ï¼Œæ·»åŠ ä¸€ä¸ªç©ºè¾“å…¥
            document.getElementById('booksContainer').innerHTML = '';
            bookInputsCounter = 0;
            addBookInput();
            
            updateBookCount();
            openListModal();
        }

        // ç¼–è¾‘ä¹¦å•
        function editList(id) {
            const list = bookLists.find(l => l.id === id);
            if (!list) return;
            
            currentEditingListId = id;
            document.getElementById('listModalTitle').textContent = 'ç¼–è¾‘ä¹¦å•';
            document.getElementById('editListId').value = id;
            document.getElementById('listMonth').value = list.month;
            document.getElementById('listTitle').value = list.title;
            
            // åŠ è½½ä¹¦ç±åˆ—è¡¨
            const container = document.getElementById('booksContainer');
            container.innerHTML = '';
            bookInputsCounter = 0;
            
            list.books.forEach(book => {
                addBookInput(book);
            });
            
            updateBookCount();
            openListModal();
        }

        // æ·»åŠ ä¹¦ç±è¾“å…¥é¡¹ï¼ˆæ”¯æŒä¼ å…¥å·²æœ‰æ•°æ®ï¼‰
        function addBookInput(bookData = null) {
            const container = document.getElementById('booksContainer');
            const emptyHint = document.getElementById('emptyBooksHint');
            
            if (emptyHint) emptyHint.style.display = 'none';
            
            bookInputsCounter++;
            const id = bookInputsCounter;
            
            const div = document.createElement('div');
            div.className = 'book-input-item bg-white border-2 border-purple-100 rounded-xl p-4 relative group hover:border-purple-300 transition-all';
            div.id = `book-input-${id}`;
            
            // ç”Ÿæˆå”¯ä¸€çš„ input id
            const fileInputId = `file-input-${id}-${Date.now()}`;
            
            div.innerHTML = `
                <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-100">
                    <span class="text-sm font-bold text-purple-700 flex items-center gap-2">
                        <span class="w-6 h-6 bg-purple-100 rounded-full flex items-center justify-center text-xs">${id}</span>
                        ä¹¦ç± #${id}
                    </span>
                    <button type="button" onclick="removeBookInput(${id})" class="text-gray-400 hover:text-red-500 transition-colors p-1 hover:bg-red-50 rounded" title="åˆ é™¤æ­¤ä¹¦">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
                
                <div class="grid md:grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">ä¹¦å *</label>
                        <input type="text" class="book-name w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition-all text-sm" placeholder="è¾“å…¥ä¹¦å" value="${bookData ? bookData.name : ''}" required>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">ä½œè€… *</label>
                        <input type="text" class="book-author w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition-all text-sm" placeholder="è¾“å…¥ä½œè€…" value="${bookData ? bookData.author : ''}" required>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="block text-xs font-medium text-gray-600 mb-1">å†…å®¹ç®€ä»‹</label>
                    <textarea class="book-content w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition-all text-sm resize-none" rows="2" placeholder="è¿™æœ¬ä¹¦è®²äº†ä»€ä¹ˆ...">${bookData ? bookData.content : ''}</textarea>
                </div>
                
                <div class="mb-3">
                    <label class="block text-xs font-medium text-gray-600 mb-1">æ¨èç†ç”±</label>
                    <textarea class="book-recommend w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition-all text-sm resize-none" rows="2" placeholder="ä¸ºä»€ä¹ˆæ¨èè¿™æœ¬ä¹¦...">${bookData ? bookData.recommend : ''}</textarea>
                </div>
                
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">å°é¢å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="${fileInputId}" accept="image/*" onchange="handleImageUpload(this, ${id})">
                        <label for="${fileInputId}" class="upload-label" id="upload-label-${id}">
                            <svg class="w-8 h-8 text-gray-400 mb-1" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <span class="text-xs text-gray-600">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</span>
                            <span class="size-hint">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                æ¨èå°ºå¯¸ï¼š800Ã—600 åƒç´ ï¼Œæ”¯æŒè‡ªåŠ¨å‹ç¼©
                            </span>
                        </label>
                        <div class="image-preview-container" id="preview-container-${id}">
                            <img id="preview-img-${id}" src="" alt="é¢„è§ˆ">
                            <button type="button" onclick="removeBookImage(${id})" class="remove-image-btn">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(div);
            updateBookCount();
            
            // å¦‚æœæœ‰å·²æœ‰å›¾ç‰‡æ•°æ®ï¼Œæ˜¾ç¤ºé¢„è§ˆ
            if (bookData && bookData.image) {
                const previewContainer = document.getElementById(`preview-container-${id}`);
                const previewImg = document.getElementById(`preview-img-${id}`);
                const uploadLabel = document.getElementById(`upload-label-${id}`);
                
                previewImg.src = bookData.image;
                previewContainer.classList.add('active');
                previewContainer.dataset.imageBase64 = bookData.image;
                uploadLabel.style.display = 'none';
            }
            
            // æ»šåŠ¨åˆ°æ–°æ·»åŠ çš„ä¹¦ç±
            div.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // ç§»é™¤ä¹¦ç±è¾“å…¥é¡¹
        function removeBookInput(id) {
            const element = document.getElementById(`book-input-${id}`);
            if (element) {
                element.remove();
                updateBookCount();
                
                // å¦‚æœæ²¡æœ‰ä¹¦ç±äº†ï¼Œæ˜¾ç¤ºæç¤º
                const container = document.getElementById('booksContainer');
                if (container.children.length === 0) {
                    document.getElementById('emptyBooksHint').style.display = 'block';
                }
                
                // é‡æ–°ç¼–å·
                updateBookNumbers();
            }
        }

        // æ›´æ–°ä¹¦ç±ç¼–å·
        function updateBookNumbers() {
            const items = document.querySelectorAll('.book-input-item');
            items.forEach((item, index) => {
                const num = index + 1;
                const badge = item.querySelector('.bg-purple-100');
                const label = item.querySelector('.text-purple-700');
                if (badge) badge.textContent = num;
                if (label) label.innerHTML = `<span class="w-6 h-6 bg-purple-100 rounded-full flex items-center justify-center text-xs">${num}</span> ä¹¦ç± #${num}`;
            });
            bookInputsCounter = items.length;
        }

        // æ›´æ–°ä¹¦ç±è®¡æ•°
        function updateBookCount() {
            const count = document.querySelectorAll('.book-input-item').length;
            document.getElementById('bookCount').textContent = `(${count} æœ¬)`;
        }

        // å¤„ç†å›¾ç‰‡ä¸Šä¼ ï¼ˆå¸¦å‹ç¼©ï¼‰
        async function handleImageUpload(input, id) {
            const file = input.files[0];
            if (!file) return;
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
                alert('è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶');
                return;
            }
            
            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆåŸå§‹æ–‡ä»¶ä¸èƒ½è¶…è¿‡ 10MBï¼‰
            if (file.size > 10 * 1024 * 1024) {
                alert('å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº 10MB çš„å›¾ç‰‡');
                return;
            }
            
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const uploadLabel = document.getElementById(`upload-label-${id}`);
                const originalContent = uploadLabel.innerHTML;
                uploadLabel.innerHTML = `
                    <svg class="animate-spin w-8 h-8 text-purple-500 mb-1" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-xs text-purple-600">æ­£åœ¨å‹ç¼©...</span>
                `;
                
                // å‹ç¼©å›¾ç‰‡
                const compressedBase64 = await compressImage(file);
                
                // æ˜¾ç¤ºé¢„è§ˆ
                const previewContainer = document.getElementById(`preview-container-${id}`);
                const previewImg = document.getElementById(`preview-img-${id}`);
                
                previewImg.src = compressedBase64;
                previewContainer.classList.add('active');
                previewContainer.dataset.imageBase64 = compressedBase64;
                uploadLabel.style.display = 'none';
                
                console.log('å›¾ç‰‡å‹ç¼©å®Œæˆï¼ŒåŸå§‹å¤§å°:', (file.size / 1024).toFixed(2), 'KB, å‹ç¼©å:', (compressedBase64.length * 0.75 / 1024).toFixed(2), 'KB');
                
            } catch (error) {
                console.error('å›¾ç‰‡å¤„ç†å¤±è´¥:', error);
                alert('å›¾ç‰‡å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•');
                // æ¢å¤åŸå§‹çŠ¶æ€
                const uploadLabel = document.getElementById(`upload-label-${id}`);
                uploadLabel.innerHTML = `
                    <svg class="w-8 h-8 text-gray-400 mb-1" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <span class="text-xs text-gray-600">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</span>
                    <span class="size-hint">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        æ¨èå°ºå¯¸ï¼š800Ã—600 åƒç´ ï¼Œæ”¯æŒè‡ªåŠ¨å‹ç¼©
                    </span>
                `;
            }
        }

        // ç§»é™¤ä¹¦ç±å›¾ç‰‡
        function removeBookImage(id) {
            const previewContainer = document.getElementById(`preview-container-${id}`);
            const previewImg = document.getElementById(`preview-img-${id}`);
            const uploadLabel = document.getElementById(`upload-label-${id}`);
            
            // æ‰¾åˆ°å¯¹åº”çš„ file input å¹¶é‡ç½®
            const fileInput = previewContainer.parentElement.querySelector('input[type="file"]');
            if (fileInput) {
                fileInput.value = '';
            }
            
            // é‡ç½®é¢„è§ˆ
            previewImg.src = '';
            previewContainer.classList.remove('active');
            delete previewContainer.dataset.imageBase64;
            uploadLabel.style.display = 'flex';
        }

        // ä¿å­˜ä¹¦å•
        function saveList(event) {
            event.preventDefault();
            
            const month = document.getElementById('listMonth').value;
            const title = document.getElementById('listTitle').value;
            
            // æ”¶é›†æ‰€æœ‰ä¹¦ç±æ•°æ®
            const books = [];
            const bookItems = document.querySelectorAll('.book-input-item');
            
            bookItems.forEach(item => {
                const name = item.querySelector('.book-name').value.trim();
                const author = item.querySelector('.book-author').value.trim();
                const content = item.querySelector('.book-content').value.trim();
                const recommend = item.querySelector('.book-recommend').value.trim();
                const previewContainer = item.querySelector('.image-preview-container');
                const image = previewContainer && previewContainer.classList.contains('active') ? previewContainer.dataset.imageBase64 : null;
                
                if (name && author) {
                    books.push({
                        name,
                        author,
                        content,
                        recommend,
                        image
                    });
                }
            });
            
            if (books.length === 0) {
                alert('è¯·è‡³å°‘æ·»åŠ ä¸€æœ¬ä¹¦ç±');
                return;
            }
            
            const listData = {
                id: currentEditingListId || Date.now().toString(),
                month,
                title,
                books,
                updatedAt: new Date().toISOString()
            };
            
            if (currentEditingListId) {
                const index = bookLists.findIndex(l => l.id === currentEditingListId);
                if (index !== -1) {
                    bookLists[index] = listData;
                }
            } else {
                bookLists.push(listData);
            }
            
            saveToStorage();
            renderLists();
            closeListModal();
        }

        // åˆ é™¤ä¹¦å•
        function deleteList(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¹¦å•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                bookLists = bookLists.filter(l => l.id !== id);
                saveToStorage();
                renderLists();
            }
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            if (bookLists.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
                return;
            }
            
            const dataStr = JSON.stringify(bookLists, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ä¹¦å•å¤‡ä»½_${new Date().toLocaleDateString()}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            // åŒæ—¶å¤åˆ¶åˆ°å‰ªè´´æ¿
            navigator.clipboard.writeText(dataStr).then(() => {
                alert('æ•°æ®å·²å¯¼å‡ºå¹¶å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼è¯·å¦¥å–„ä¿å­˜ JSON æ–‡ä»¶æˆ–æ–‡æœ¬ï¼Œä»¥ä¾¿åœ¨å…¶ä»–è®¾å¤‡å¯¼å…¥ã€‚');
            }).catch(() => {
                alert('æ•°æ®å·²å¯¼å‡ºï¼è¯·ä¿å­˜ JSON æ–‡ä»¶ä»¥ä¾¿åœ¨å…¶ä»–è®¾å¤‡ä½¿ç”¨ã€‚');
            });
        }

        // å¯¼å…¥æ•°æ®
        function importData() {
            document.getElementById('importModal').classList.remove('hidden');
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.add('hidden');
            document.getElementById('importDataInput').value = '';
            // é‡ç½®æ–‡ä»¶è¾“å…¥
            document.getElementById('importFileInput').value = '';
        }

        // å¤„ç†å¯¼å…¥æ•°æ®
        function processImportData(content) {
            try {
                const data = JSON.parse(content);
                if (!Array.isArray(data)) {
                    throw new Error('æ•°æ®æ ¼å¼é”™è¯¯');
                }
                
                // éªŒè¯æ•°æ®æ ¼å¼
                const isValid = data.every(item => 
                    item.id && item.month && item.title && Array.isArray(item.books)
                );
                
                if (!isValid) {
                    throw new Error('æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                }
                
                bookLists = data;
                saveToStorage();
                renderLists();
                closeImportModal();
                alert('å¯¼å…¥æˆåŠŸï¼');
            } catch (e) {
                alert('å¯¼å…¥å¤±è´¥ï¼š' + e.message);
            }
        }

        function confirmImport() {
            const input = document.getElementById('importDataInput').value.trim();
            if (!input) {
                alert('è¯·è¾“å…¥æ•°æ®æˆ–é€‰æ‹©æ–‡ä»¶');
                return;
            }
            
            if (confirm(`ç¡®å®šè¦å¯¼å…¥æ•°æ®å—ï¼Ÿè¿™å°†è¦†ç›–å½“å‰çš„æ‰€æœ‰æ•°æ®ã€‚`)) {
                processImportData(input);
            }
        }

        // ä¸‹è½½å¡ç‰‡ä¸ºå›¾ç‰‡ - ä¼˜åŒ–ç‰ˆæœ¬ï¼Œå›¾ç‰‡ä¿æŒåŸå§‹å°ºå¯¸
        async function downloadCard(id) {
            const list = bookLists.find(l => l.id === id);
            if (!list) return;
            
            // åˆ›å»ºä¸“é—¨ç”¨äºä¸‹è½½çš„å®¹å™¨
            const clone = document.createElement('div');
            clone.style.width = '520px';
            clone.style.background = 'white';
            clone.style.padding = '0';
            clone.style.borderRadius = '16px';
            clone.style.overflow = 'hidden';
            clone.style.boxShadow = '0 25px 50px -12px rgba(0, 0, 0, 0.25)';
            clone.style.fontFamily = "'Noto Sans SC', sans-serif";
            
            // æ„å»ºä¹¦ç±åˆ—è¡¨ HTMLï¼Œå›¾ç‰‡ä¿æŒåŸå§‹å°ºå¯¸
            const booksHtml = list.books.map((book, index) => {
                // å›¾ç‰‡ä¿æŒåŸå§‹å°ºå¯¸ï¼Œä½¿ç”¨ object-fit: contain é¿å…è£å‰ª
                let imageHtml = '';
                if (book.image) {
                    imageHtml = `
                        <div style="margin-top: 12px; border-radius: 8px; overflow: hidden; background: #f3f4f6; text-align: center;">
                            <img src="${book.image}" 
                                 style="max-width: 100%; height: auto; max-height: 300px; object-fit: contain; display: inline-block; background: #f3f4f6;" 
                                 alt="${book.name}">
                        </div>
                    `;
                }
                
                // æ„å»ºå†…å®¹åŒºåŸŸï¼Œä¿ç•™æŠ¬å¤´æ ‡ç­¾
                let contentHtml = '';
                if (book.content && book.content.trim()) {
                    contentHtml = `
                        <div style="margin-top: 10px; margin-left: 36px;">
                            <div style="font-size: 12px; color: #6b7280; font-weight: 600; margin-bottom: 4px;">å†…å®¹ç®€ä»‹ï¼š</div>
                            <div style="font-size: 13px; color: #4b5563; line-height: 1.6;">${book.content}</div>
                        </div>
                    `;
                }
                
                let recommendHtml = '';
                if (book.recommend && book.recommend.trim()) {
                    recommendHtml = `
                        <div style="margin-top: 10px; margin-left: 36px;">
                            <div style="font-size: 12px; color: #7c3aed; font-weight: 600; margin-bottom: 4px;">æ¨èç†ç”±ï¼š</div>
                            <div style="font-size: 13px; color: #7c3aed; padding: 10px; background: #f5f3ff; border-radius: 8px; font-style: italic; border-left: 3px solid #8b5cf6; line-height: 1.6;">${book.recommend}</div>
                        </div>
                    `;
                }
                
                return `
                    <div style="margin-bottom: 20px; padding: 16px; background: #f9fafb; border-radius: 12px; border: 1px solid #e5e7eb;">
                        <div style="display: flex; gap: 12px; align-items: flex-start;">
                            <div style="width: 28px; height: 28px; background: #ede9fe; color: #7c3aed; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; flex-shrink: 0;">${index + 1}</div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="margin-bottom: 8px;">
                                    <div style="font-size: 12px; color: #6b7280; font-weight: 600; margin-bottom: 2px;">ä¹¦åï¼š</div>
                                    <div style="font-weight: bold; color: #1f2937; font-size: 16px; line-height: 1.4;">${book.name}</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: #6b7280; font-weight: 600; margin-bottom: 2px;">ä½œè€…ï¼š</div>
                                    <div style="font-size: 13px; color: #4b5563;">${book.author}</div>
                                </div>
                            </div>
                        </div>
                        ${contentHtml}
                        ${recommendHtml}
                        ${imageHtml}
                    </div>
                `;
            }).join('');
            
            clone.innerHTML = `
                <div style="background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%); padding: 28px 24px; color: white; position: relative;">
                    <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px; font-weight: 500;">${list.month} Â· å…± ${list.books.length} æœ¬</div>
                    <div style="font-size: 26px; font-weight: bold; font-family: 'Noto Serif SC', serif; line-height: 1.3;">${list.title}</div>
                </div>
                <div style="padding: 24px; background: white;">
                    ${booksHtml}
                </div>
                <div style="padding: 16px; text-align: center; font-size: 12px; color: #9ca3af; border-top: 1px solid #e5e7eb; background: #fafafa;">
                    ç”Ÿæˆäº ${new Date().toLocaleDateString()} Â· æˆ‘çš„ä¹¦å•
                </div>
            `;
            
            document.body.appendChild(clone);
            
            try {
                const canvas = await html2canvas(clone, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    logging: false,
                    imageTimeout: 0,
                    onclone: function(clonedDoc) {
                        const images = clonedDoc.querySelectorAll('img');
                        images.forEach(img => {
                            img.crossOrigin = 'anonymous';
                        });
                    }
                });
                
                const image = canvas.toDataURL('image/png', 1.0);
                
                const preview = document.getElementById('downloadPreview');
                preview.innerHTML = `<img src="${image}" style="width: 100%; display: block; height: auto;">`;
                
                const link = document.getElementById('downloadLink');
                link.href = image;
                link.download = `${list.title}_${list.month}.png`;
                
                document.getElementById('downloadModal').classList.remove('hidden');
                
            } catch (err) {
                console.error('ç”Ÿæˆå›¾ç‰‡å¤±è´¥:', err);
                alert('ç”Ÿæˆå›¾ç‰‡å¤±è´¥ï¼Œè¯·é‡è¯•');
            } finally {
                document.body.removeChild(clone);
            }
        }

        function closeDownloadModal() {
            document.getElementById('downloadModal').classList.add('hidden');
        }

        // æ¨¡æ€æ¡†æ§åˆ¶
        function openListModal() {
            document.getElementById('listModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeListModal() {
            document.getElementById('listModal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        // ç­›é€‰åŠŸèƒ½
        document.getElementById('filterMonth').addEventListener('change', renderLists);

        function clearFilter() {
            document.getElementById('filterMonth').value = '';
            renderLists();
        }

        // ç‚¹å‡»å¤–éƒ¨å…³é—­æ¨¡æ€æ¡†
        document.getElementById('listModal').addEventListener('click', function(e) {
            if (e.target === this) closeListModal();
        });

        document.getElementById('importModal').addEventListener('click', function(e) {
            if (e.target === this) closeImportModal();
        });

        document.getElementById('downloadModal').addEventListener('click', function(e) {
            if (e.target === this) closeDownloadModal();
        });
    </script>
</body>
</html>
